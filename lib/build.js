const e=require("fs"),r=require("util"),s=require("chalk"),t=require("chokidar"),i=require("easy-table"),n=require("open"),o=require("ora"),c=require("scp2"),l=require("webpack"),a=require("webpack-dev-server"),{errorCb:u,openPath:d,proxy:p,successCb:g,uploadOpts:f}=require("../config/bruce"),{BUILD_TEXT:b,FormatBool:S}=require("../i18n"),{BuildAnswer:j,DllAnswer:h}=require("../pipe"),{HOST:y,IGNORE_DEPS:E}=require("../util/getting"),{AbsPath:q,AsyncTo:w,BuildCb:x,DataType:O,DiffArray:k,GetUrl:U,IsEmptyArray:_,IsExist:m,IsMpa:A,ReadEntry:L,ReadFolder:P,ShowMsg:B,ShowTitle:D}=require("../util/setting");function T(e){let r=!1;if(A()){const s=P("src/pages");s.reduce((r,s)=>{const t=`src/pages/${s}/index.${e?"tsx":"jsx"}`,i=t.replace(/sx*$/g,"s");return m(t)&&(r+=1),m(i)&&(r+=1),r},0)===s.length&&(r=!0)}else{let s=0;const t="src/index."+(e?"tsx":"jsx"),i=t.replace(/sx*$/g,"s");m(t)&&(s+=1),m(i)&&(s+=1),1===s&&(r=!0)}return r}function F(r){const s=L();return s.reduce((t,i)=>{const n=`src${s.length>1?"/pages/"+i:""}/index.${r?"tsx":"jsx"}`,o=n.replace(/sx/g,"s"),c=m(n)?q(n):m(o)?q(o):"";if(c){const r=["@babel/polyfill","core-js","regenerator-runtime"],s=e.readFileSync(c,"utf8");return r.some(e=>s.includes(e))?t+1:t}return t},0)>0}function v(){const{dependencies:e={}}=require(q("package.json")),r=require(q("dist/static/vendor.json")),s=Object.keys(e).sort().reduce((e,r)=>(E.every(e=>!r.includes(e))&&e.push(r),e),[]),t=k(r,s),i=k(s,r);return _(t)&&_(i)}async function I(){const{VENDOR:r}=await h(),s=require("../config/webpack.dll"),[t,i]=await x(s(r));if(t||!i)B("red",b.dllFail),process.exit(1);else{const s=q("dist/static/vendor.json"),t=JSON.stringify(r,null,"\t");e.writeFileSync(s,t,"utf8"),B("green",b.dllSucceed)}}function M(e){const{MODE:r,USE_ANALYZE:t,USE_COMPRESS:n,USE_CSSLINT:o,USE_ES6:c,USE_HASH:l,USE_JSLINT:a,USE_POLYFILL:u,USE_TIMED:d,USE_UPLOAD:p}=e,{name:g}=require(q("package.json")),f={name:g,mode:b.table.env[r],csslint:o,jslint:a,es6:c,polyfill:u,hash:l,timed:d,compress:n,analyze:t,upload:p},j=new i;Object.entries(f).filter(e=>void 0!==e[1]).forEach((e,r)=>{const t=b.table[e[0]],i=O(e[1],"boolean")?S(e[1]):e[1];j.cell("title",s[`bg${r%2==0?"Blue":"Magenta"}Bright`](t)),j.cell("desc",s.cyanBright(i)),j.newRow()}),console.log("\n"+j.print())}async function N(e){const s=r.promisify(c.scp)(q("dist/"+e),f(e)),t=o(b.uploading);t.start();const[i]=await w(s);t.stop(),i?(console.log(i),B("red",b.uploadFail)):B("green",b.uploadSucceed)}module.exports=async function(){if(D("build"),!m("brucerc.js"))return B("red",b.judgeBrucerc);if(!m("package.json"))return B("red",b.judgePackage);if(!m("src"))return B("red",b.judgeSrc);if(!m("node_modules"))return B("red",b.judgeModules);const{frame:e,useTs:r}=require("../config/bruce"),{dependencies:{"@babel/polyfill":i,"core-js":o}}=require(q("package.json")),c=F(r);if(r&&!m("tsconfig.json"))return B("red",b.judgeTsconfig);if(!T(r))return B("red",b.judgeEntry);if(c){if(i)return B("red",b.judgePolyfill);if(o&&o>="3.0.0")return B("red",b.judgeCorejs)}"default"===e||m("dist/static")&&v()||await I();const S=await j(c),{MODE:h}=S;if("dev"===h){const{PORT:e,USE_OPEN:r}=S,i=require("../config/webpack.dev"),o=l(i(S)),c=new a(o,{contentBase:q("dist"),disableHostCheck:!0,historyApiFallback:!0,host:y,hot:!0,open:!1,overlay:!0,port:e,proxy:p,publicPath:U(e)+"/",quiet:!0}),u=t.watch([q("brucerc.js"),q("package.json"),q("tsconfig.json"),q("src/global.d.ts")]);c.listen(e,y,t=>{if(t)B("red",b.buildFail);else{const t=U(e,d),i=U(e,d,!0);console.log(s.yellowBright(b.listening)),console.log(b.listLocalhost+s.blueBright(t)),console.log(b.listNetwork+s.blueBright(i)),r&&n(t,{app:"chrome"})}}),u.on("change",e=>{const r=e.replace(/\\/g,"/").split("/").pop();console.log(b.watch(r)),process.exit(1)})}else{M(S);const{MODE:e,USE_UPLOAD:r}=S,s=require("../config/webpack.prod")(Object.assign(S,{HAS_POLYFILL:c})),[t,i]=await x(s);t||!i?(B("red",b.buildFail),u&&u(t)):(B("green",b.buildSucceed),g&&g(e,s.output.path),r&&f&&N(e))}};