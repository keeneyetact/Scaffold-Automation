const e=require("fs"),r=require("util"),t=require("chalk"),s=require("easy-table"),i=require("open"),n=require("ora"),o=require("scp2"),c=require("webpack"),l=require("webpack-dev-server"),{errorCb:u,openPath:a,proxy:d,successCb:g,uploadOpts:p}=require("../config/bruce"),{BUILD_TEXT:f,FormatBool:b}=require("../i18n"),{BuildAnswer:S,DllAnswer:E}=require("../pipe"),{HOST:y,IGNORE_DEPS:j}=require("../util/getting"),{AbsPath:h,AsyncTo:q,BuildCb:w,DataType:O,DiffArray:x,GetUrl:k,IsEmptyArray:U,IsExist:_,IsMpa:m,ReadEntry:A,ReadFolder:L,ShowMsg:P,ShowTitle:B}=require("../util/setting");function D(e){let r=!1;if(m()){const t=L("src/pages");t.reduce((r,t)=>{const s=`src/pages/${t}/index.${e?"tsx":"jsx"}`,i=s.replace(/sx*$/g,"s");return _(s)&&(r+=1),_(i)&&(r+=1),r},0)===t.length&&(r=!0)}else{let t=0;const s=`src/index.${e?"tsx":"jsx"}`,i=s.replace(/sx*$/g,"s");_(s)&&(t+=1),_(i)&&(t+=1),1===t&&(r=!0)}return r}function T(r){const t=A();return t.reduce((s,i)=>{const n=`src${t.length>1?`/pages/${i}`:""}/index.${r?"tsx":"jsx"}`,o=n.replace(/sx/g,"s"),c=_(n)?h(n):_(o)?h(o):"";if(c){const r=["@babel/polyfill","core-js","regenerator-runtime"],t=e.readFileSync(c,"utf8");return r.some(e=>t.includes(e))?s+1:s}return s},0)>0}function F(){const{dependencies:e={}}=require(h("package.json")),r=require(h("dist/static/vendor.json")),t=Object.keys(e).sort().reduce((e,r)=>(!j.includes(r)&&e.push(r),e),[]),s=x(r,t),i=x(t,r);return U(s)&&U(i)}async function I(){const{VENDOR:r}=await E(),t=require("../config/webpack.dll"),[s,i]=await w(t(r));if(s||!i)P("red",f.dllFail);else{const t=h("dist/static/vendor.json"),s=JSON.stringify(r,null,"\t");e.writeFileSync(t,s,"utf8"),P("green",f.dllSucceed)}}function $(e){const{MODE:r,USE_ANALYZE:i,USE_COMPRESS:n,USE_CSSLINT:o,USE_ES6:c,USE_HASH:l,USE_JSLINT:u,USE_POLYFILL:a,USE_TIMED:d,USE_UPLOAD:g}=e,{name:p}=require(h("package.json")),S={name:p,mode:f.table.env[r],csslint:o,jslint:u,es6:c,polyfill:a,hash:l,timed:d,compress:n,analyze:i,upload:g},E=new s;Object.entries(S).forEach((e,r)=>{if(void 0!==e[1]){const s=f.table[e[0]],i=O(e[1],"boolean")?b(e[1]):e[1];E.cell("title",t[`bg${r%2==0?"Blue":"Magenta"}Bright`](s)),E.cell("desc",t.cyanBright(i)),E.newRow()}}),console.log("\n"+E.print())}async function v(e){const t=r.promisify(o.scp)(h(`dist/${e}`),p(e)),s=n(f.uploading);s.start();const[i]=await q(t);s.stop(),i?(console.log(i),P("red",f.uploadFail)):P("green",f.uploadSucceed)}module.exports=async function(){if(B("build"),!_("brucerc.js"))return P("red",f.judgeBrucerc);if(!_("package.json"))return P("red",f.judgePackage);if(!_("src"))return P("red",f.judgeSrc);if(!_("node_modules"))return P("red",f.judgeModules);const{frame:e,useTs:r}=require("../config/bruce"),{dependencies:{"@babel/polyfill":s,"core-js":n}}=require(h("package.json")),o=T(r);if(r&&!_("tsconfig.json"))return P("red",f.judgeTsconfig);if(!D(r))return P("red",f.judgeEntry);if(o){if(s)return P("red",f.judgePolyfill);if(n&&n>="3.0.0")return P("red",f.judgeCorejs)}"default"===e||_("dist/static")&&F()||await I();const b=await S(o),{MODE:E}=b;if("dev"===E){const{PORT:e,USE_OPEN:r}=b,s=require("../config/webpack.dev"),n=c(s(b));new l(n,{contentBase:h("dist"),disableHostCheck:!0,historyApiFallback:!0,host:y,hot:!0,open:!1,overlay:!0,port:e,proxy:d,publicPath:k(e)+"/",quiet:!0}).listen(e,y,s=>{if(s)P("red",f.buildFail);else{const s=k(e,a),n=k(e,a,!0);console.log(t.yellowBright(f.listening)),console.log(f.listLocalhost+t.blueBright(s)),console.log(f.listNetwork+t.blueBright(n)),r&&i(s,{app:"chrome"})}})}else{$(b);const{MODE:e,USE_UPLOAD:r}=b,t=require("../config/webpack.prod")(Object.assign(b,{HAS_POLYFILL:o})),[s,i]=await w(t);s||!i?(P("red",f.buildFail),u&&u(s)):(P("green",f.buildSucceed),g&&g(e,t.output.path),r&&p&&v(e))}};