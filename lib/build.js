const e=require("fs"),r=require("util"),s=require("chalk"),t=require("chokidar"),i=require("easy-table"),n=require("open"),o=require("ora"),c=require("scp2"),l=require("semver"),a=require("webpack"),u=require("webpack-dev-server"),{errorCb:d,openPath:p,proxy:g,successCb:f,uploadOpts:b}=require("../config/bruce"),{BUILD_TEXT:S,FormatBool:E,QUESTION_TEXT:j}=require("../i18n"),{BuildAnswer:h,DllAnswer:y}=require("../pipe"),{HOST:q,IGNORE_DEPS:w}=require("../util/getting"),{AbsPath:O,AsyncTo:k,BuildCb:m,DataType:x,DiffArray:U,GetUrl:_,IsEmptyArray:T,IsExist:A,IsMpa:L,ReadEntry:P,ReadFolder:v,ShowMsg:B,ShowTitle:D}=require("../util/setting");function F(e){let r=!1;if(L()){const s=v("src/pages");s.reduce((r,s)=>{const t=`src/pages/${s}/index.${e?"tsx":"jsx"}`,i=t.replace(/sx*$/g,"s");return A(t)&&(r+=1),A(i)&&(r+=1),r},0)===s.length&&(r=!0)}else{let s=0;const t="src/index."+(e?"tsx":"jsx"),i=t.replace(/sx*$/g,"s");A(t)&&(s+=1),A(i)&&(s+=1),1===s&&(r=!0)}return r}function I(r){const s=P();return s.reduce((t,i)=>{const n=`src${s.length>1?"/pages/"+i:""}/index.${r?"tsx":"jsx"}`,o=n.replace(/sx/g,"s"),c=A(n)?O(n):A(o)?O(o):"";if(c){const r=["@babel/polyfill","core-js","regenerator-runtime"],s=e.readFileSync(c,"utf8");return r.some(e=>s.includes(e))?t+1:t}return t},0)>0}function M(){const{dependencies:e={}}=require(O("package.json")),r=require(O("dist/static/vendor.json")),s=Object.keys(e).sort().reduce((e,r)=>(w.every(e=>!r.includes(e))&&e.push(r),e),[]),t=U(r,s),i=U(s,r);return T(t)&&T(i)}async function N(){const{VENDOR:r}=await y(),s=require("../config/webpack.dll"),[t,i]=await m(s(r));if(t||!i)B("red",S.dllFail),process.exit(1);else{const s=O("dist/static/vendor.json"),t=JSON.stringify(r,null,"\t");e.writeFileSync(s,t,"utf8"),B("green",S.dllSucceed)}}function C(e){const{MODE:r,USE_ANALYZE:t,USE_COMPRESS:n,USE_CSSLINT:o,USE_ES6:c,USE_HASH:l,USE_JSLINT:a,USE_POLYFILL:u,USE_TIMED:d,USE_UPLOAD:p}=e,{name:g}=require(O("package.json")),f={name:g,mode:S.table.env[r],csslint:o,jslint:a,es6:c,polyfill:u,hash:l,timed:d,compress:n,analyze:t,upload:p},b=new i;Object.entries(f).filter(e=>void 0!==e[1]).forEach((e,r)=>{const t=S.table[e[0]],i=x(e[1],"boolean")?E(e[1]):e[1];b.cell("title",s.black[`bg${r%2==0?"Blue":"Magenta"}Bright`](t)),b.cell("desc",s.cyanBright(i)),b.newRow()}),console.log("\n"+b.print())}async function R(e){const s=r.promisify(c.scp)(O("dist/"+e),b(e)),t=o(S.uploading).start(),[i]=await k(s);t.stop(),i?(console.log(i),B("red",S.uploadFail)):B("green",S.uploadSucceed)}module.exports=async function(){if(D("build"),!A("brucerc.js"))return B("red",S.judgeBrucerc);if(!A("package.json"))return B("red",S.judgePackage);if(!A("src"))return B("red",S.judgeSrc);if(!A("node_modules"))return B("red",S.judgeModules);const{frame:e,useTs:r}=require("../config/bruce"),{dependencies:{"@babel/polyfill":i,"core-js":o},name:c,version:E}=require(O("package.json")),y=I(r);if(r&&!A("tsconfig.json"))return B("red",S.judgeTsconfig);if(!F(r))return B("red",S.judgeEntry);if(y){if(i)return B("red",S.judgePolyfill);if(o&&l.lt(o,"3.0.0"))return B("red",S.judgeCorejs)}"default"===e||A("dist/static")&&M()||await N();const w=await h(y),{MODE:k}=w;if("dev"===k){const{PORT:e,USE_OPEN:r}=w,i=require("../config/webpack.dev"),o=a(i(w)),c=new u(o,{contentBase:O("dist"),disableHostCheck:!0,historyApiFallback:!0,host:q,hot:!0,open:!1,overlay:!0,port:e,proxy:g,publicPath:_(e)+"/",quiet:!0}),l=t.watch([O("brucerc.js"),O("package.json"),O("tsconfig.json"),O("src/global.d.ts")]);c.listen(e,q,t=>{if(t)B("red",S.buildFail);else{const t=_(e,p),i=_(e,p,!0);console.log(s.yellowBright(S.listening)),console.log(S.listLocalhost+s.blueBright(t)),console.log(S.listNetwork+s.blueBright(i)),r&&n(t,{app:"chrome"})}}),l.on("change",e=>{const r=e.replace(/\\/g,"/").split("/").pop();console.log(S.watch(r)),process.exit(1)})}else{C(w);const{MODE:e,USE_UPLOAD:r}=w,s=require("../config/webpack.prod")(Object.assign(w,{HAS_POLYFILL:y})),[t,i]=await m(s);t||!i?(B("red",S.buildFail(c,E,j.modeMap[e])),d&&d(t)):(B("green",S.buildSucceed(c,E,j.modeMap[e])),f&&f(e,s.output.path),r&&b&&R(e))}};