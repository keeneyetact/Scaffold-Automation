const e=require("child_process"),t=require("fs"),s=require("util"),i=require("make-dir"),r=require("ora"),a=require("recursive-copy"),{PACKAGE:p,REACT_PORJECT:c,VUE_COMPONENT:o,VUE_PROJECT:n}=require("./template"),{NEW_TEXT:l}=require("../i18n"),{AbsPath:u,AsyncTo:h,TitleCase:m}=require("../util/setting");module.exports=class{constructor({compName:e="components/demo",deps:t={},devDeps:s={},frame:i="default",projName:r="demo",style:a="scss",useMpa:p=!1,useTs:c=!1}){this.frame=i,this.projName=r,this.compName=`src/${e}`,this.style=a,this.deps=t,this.devDeps=s,this.useMpa=p,this.useTs=c,this.writeProject={default:this.initProjForD,react:this.initProjForR,vue:this.initProjForV}[i],this.writeComponent={react:this.initCompForR,vue:this.initCompForV}[i]}allPath(e,t){const s=this.useMpa?`pages/${e}/`:"";return`${this.projName}/src/${s}${t}`}async writeConfig(){t.mkdirSync(u(this.projName));const e=u("../temp/configs/brucerc.js",1),s=u(`${this.projName}/brucerc.js`),i=t.readFileSync(e,"utf8").replace(/frame: "default"/g,`frame: "${this.frame}"`).replace(/style: "scss"/g,`style: "${this.style}"`).replace(/useTs: false/g,`useTs: ${this.useTs}`);t.writeFileSync(s,i,"utf8");const r=Object.assign(p,{dependencies:this.deps,devDependencies:this.devDeps,name:this.projName}),c=u(`${this.projName}/package.json`),o=JSON.stringify(r,null,"\t");if(t.writeFileSync(c,o,"utf8"),this.useTs){const e=u("../temp/configs/tsconfig.json",1),t=u(`${this.projName}/tsconfig.json`);await a(e,t)}const n=u("../temp/assets",1),l=u(`${this.projName}/src/assets`);await a(n,l)}async initProjForD(){await this.writeConfig();const e=u("../temp/projects/default",1),t=u(`${this.projName}/src`);await a(e,t)}async initProjForR(){await this.writeConfig();const e=this.useMpa?["home","about","contact"]:["index"],s=this.useTs?"ts":"js",{imports:r}=c,a=u("../temp/projects/react/template.txt",1),p=t.readFileSync(a,"utf8"),o=u("../temp/projects/react/style.txt",1),n=t.readFileSync(o,"utf8"),l=u("../temp/projects/react/script.txt",1),h=t.readFileSync(l,"utf8");for(let a of e){this.useMpa&&await i(u(`${this.projName}/src/pages/${a}`));const e=u(this.allPath(a,"index.html")),c=p.replace(/Demo/g,m(a));t.writeFileSync(e,c,"utf8");const o=u(this.allPath(a,`index.${this.style}`)),l=n.replace(/demo/g,a);t.writeFileSync(o,l,"utf8");const d=u(this.allPath(a,`index.${s}x`)),y=h.replace(/#imports#/g,r[s]).replace(/.\/assets/g,this.useMpa?"@/assets":"./assets").replace(/scss/g,this.style).replace(/demo/g,a).replace(/render\(\)/g,this.useTs?"public render()":"render()").replace(/note/g,this.useTs?"tslint:disable-line":"eslint-disable-line");t.writeFileSync(d,y,"utf8")}}async initProjForV(){await this.writeConfig();const e=this.useMpa?["home","about","contact"]:["index"],s=this.useTs?"ts":"js",{imports:r,name:p}=n,c=u("../temp/projects/vue/shim-vue.d.ts",1),o=u(`${this.projName}/src/shim-vue.d.ts`);this.useTs&&await a(c,o);const l=u("../temp/projects/vue/template.txt",1),h=t.readFileSync(l,"utf8"),d=u("../temp/projects/vue/script.txt",1),y=t.readFileSync(d,"utf8"),f=u("../temp/projects/vue/vue.txt",1),g=t.readFileSync(f,"utf8");for(let a of e){this.useMpa&&await i(u(`${this.projName}/src/pages/${a}`));const e=u(this.allPath(a,"index.html")),c=h.replace(/Demo/g,m(a));t.writeFileSync(e,c,"utf8");const o=u(this.allPath(a,`index.${s}`)),n=y.replace(/.\/assets/g,this.useMpa?"@/assets":"./assets").replace(/render: h/g,this.useTs?"render: (h: any)":"render: h");t.writeFileSync(o,n,"utf8");const l=u(this.allPath(a,"app.vue")),d=g.replace(/#imports#/g,r[s]).replace(/#name#/g,p[s]).replace(/.\/assets/g,this.useMpa?"../../assets":"./assets").replace(/demo/g,a).replace(/scss/g,this.style).replace(/export default/g,this.useTs?"export default class App extends Vue":"export default").replace(/mounted/g,this.useTs?"public mounted":"mounted").replace(/note/g,this.useTs?"tslint:disable-line":"eslint-disable-line");t.writeFileSync(l,d,"utf8")}}async initCompForR(){await i(u(this.compName));const a=this.compName.split("/").pop(),p=this.useTs?"ts":"js",c=u("../temp/components/react/style.txt",1),o=u(`${this.compName}/index.${this.style}`),n=t.readFileSync(c,"utf8").replace(/demo/g,a);t.writeFileSync(o,n,"utf8");const d=u("../temp/components/react/script.txt",1),y=u(`${this.compName}/index.${p}x`),f=t.readFileSync(d,"utf8").replace(/#interface#/g,this.useTs?"<{done: string}>":"").replace(/scss/g,this.style).replace(/Demo/g,m(a)).replace(/demo/g,a).replace(/static/g,this.useTs?"public static":"static").replace(/render/g,this.useTs?"public render":"render").replace(/\};/g,this.useTs?"};":"}");if(t.writeFileSync(y,f,"utf8"),!this.deps["prop-types"]){const t=`yarn add prop-types${this.useTs?" && yarn add -D @types/prop-types":""}`,i=`npm i prop-types${this.useTs?" && npm i -D @types/prop-types":""}`,a=s.promisify(e.exec),p=r(l.installing);p.start();const[c,o]=await h(a(t));(c||!o)&&await a(i),p.stop()}}async initCompForV(){await i(u(this.compName));const e=this.compName.split("/").pop(),s=this.useTs?"ts":"js",{exportss:r,imports:a}=o,p=u("../temp/components/vue/vue.txt",1),c=u(`${this.compName}/index.vue`),n=t.readFileSync(p,"utf8").replace(/#imports#/g,a[s]).replace(/#exports#/g,r[s]).replace(/demo/g,e).replace(/Demo/g,m(e)).replace(/scss/g,this.style);t.writeFileSync(c,n,"utf8")}};