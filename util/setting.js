const e=require("fs"),t=require("os"),n=require("path"),r=require("url"),o=require("util"),s=require("chalk"),i=require("easy-table"),c=require("latest-version"),l=require("terser"),a=require("webpack");module.exports={AbsPath:B,AsyncTo:x,AutoBin:w,BuildCb:S,CheckEntry:$,CheckJsType:j,CheckPolyfill:b,CompressJs:v,DebugLoaders:q,GetUrl:I,GetVersion:k,IsEmptyArray:T,IsEmptyObject:A,IsExist:C,ReadAll:_,ReadEntry:E,ReadFolder:O,ShowInfo:F,ShowMsg:z,ShowTitle:P,TitleCase:R};const{ACTION_TEXT:u,INFO_TEXT:d,FormatBool:g}=require("../i18n"),{HOST:m,IS_MPA:f,IS_TS:h,NAME:p,PORT:y}=require("./getting");function B(e,t){const r=t?__dirname:process.cwd();return n.join(r,e)}function x(e){return e.then(e=>[null,e]).catch(e=>[e])}function w(e,...t){require(`../lib/${e}`)(...t)}async function S(e){const t=o.promisify(a),n=await t(e);return x(new Promise((e,t)=>{process.stdout.write(n.toString({children:!1,chunkModules:!1,chunks:!1,colors:!0,modules:!1})+"\n\n"),n.hasErrors()?t(!1):e(!0)}))}function $(){let e=!1;if(f){const t=O("src/pages");t.reduce((e,t)=>{const n=`src/pages/${t}/index.${h?"tsx":"jsx"}`,r=n.replace(/sx/g,"s");return C(n)&&(e+=1),C(r)&&(e+=1),e},0)===t.length&&(e=!0)}else{let t=0;const n=`src/index.${h?"tsx":"jsx"}`,r=n.replace(/sx/g,"s");C(n)&&(t+=1),C(r)&&(t+=1),1===t&&(e=!0)}return e}function j(){const e={js:0,jsx:0,ts:0,tsx:0},t=Object.keys(e);_(B("src"),r=>{const o=n.extname(r).replace(/\./g,"");t.includes(o)&&(e[o]=e[o]+1)});const{js:r,jsx:o,ts:s,tsx:i}=e;return!r&&!o||s||i||h?r||o||!s&&!i||!h?"none":"ts":"js"}function b(){const t=E("src");return t.reduce((n,r)=>{const o=`src${t.length>1?`/pages/${r}`:""}/index.${h?"tsx":"jsx"}`,s=o.replace(/sx/g,"s"),i=C(o)?B(o):C(s)?B(s):"";if(i){return e.readFileSync(i,"utf8").includes('import "@babel/polyfill"')?n+1:n}return n},0)>0}function v(t){_(t,t=>{if(".js"===n.extname(t)){const n={mangle:{toplevel:!0},nameCache:{}},r=e.readFileSync(t,"utf8"),o=l.minify(r.replace(/"use strict";/,""),n);e.writeFileSync(t,o.code,"utf8")}})}function q(e){console.log(s.redBright("----- Debug Loaders -----"));const t=new i,n={css:null,js:null,img:null,font:null,media:null};Object.keys(n).forEach((r,o)=>{n[r]=e[o].use.map(e=>{if(e.loader.includes("node_modules")){const t=e.loader.split("\\"),n=t.findIndex(e=>"node_modules"===e);return t[n+1]}return e.loader}),t.cell("File",s.magentaBright(r)),t.cell("Loader",s.cyanBright(n[r].reverse().join(" "))),t.newRow()}),console.log(t.toString());const r=new i,{plugins:o,presets:c}=e[1].use[0].options,l={plugins:o,presets:c};for(let e in l)l[e]=l[e].map(e=>{let t=e.constructor===Array?e[0]:e;if(t.includes("node_modules")){const e=t.split("\\"),n=e.findIndex(e=>"node_modules"===e);t=e[n+1]}return t}),r.cell("Option",s.magentaBright(e)),r.cell("Package",s.cyanBright(l[e].join(" "))),r.newRow();console.log(r.toString())}function I(e=y,n,o){const s=o?(()=>{const e=t.networkInterfaces();for(let t in e)for(var n=0;n<e[t].length;n++){var r=e[t][n];if("IPv4"===r.family&&"127.0.0.1"!==r.address&&!r.internal)return r.address}})():"",i=r.format({hostname:s||m,pathname:n,port:e,protocol:"http"});return decodeURIComponent(i)}async function k(e){return e.reduce(async(e,t)=>{const n=await e,r=await c(t);return n[t]=r,n},Promise.resolve({}))}function T(e){return Array.isArray(e)&&!e.length}function A(e){return e.constructor===Object&&!Object.keys(e).length}function C(t,n){return e.existsSync(B(t,n))}function _(t,r){const o=e.readdirSync(t);for(let s of o){const o=n.normalize(`${t}/${s}`),i=e.statSync(o);i.isFile()&&r&&r(o),i.isDirectory()&&"node_modules"!==s&&_(o,r)}}function E(t,r){let o=[];if(C(t,r))if(f){const s=B(`${t}/pages`,r);o=e.readdirSync(s).filter(t=>e.statSync(n.normalize(`${s}/${t}`)).isDirectory())}else{const s=B(t,r);o=e.readdirSync(s).filter(t=>e.statSync(n.normalize(`${s}/${t}`)).isFile()&&".html"===n.extname(n.normalize(`${s}/${t}`))).map(e=>e.split(".")[0])}return o}function O(t,r){const o=B(t,r);return C(t,r)?e.readdirSync(o).filter(t=>e.statSync(n.normalize(`${o}/${t}`)).isDirectory()):[]}function F(e){const{analyze:t,compress:n,hash:r,mode:o,output:c,polyfill:l,timed:a,upload:u}=e,m=d.env[o],f=new i;f.cell(s.magentaBright(d.project),s.cyanBright(p||"demo")),f.cell(s.magentaBright(d.mode),s.cyanBright(m)),void 0!==c&&f.cell(s.magentaBright(d.output),s.cyanBright(g(c))),void 0!==l&&f.cell(s.magentaBright(d.polyfill),s.cyanBright(g(l))),void 0!==r&&f.cell(s.magentaBright(d.hash),s.cyanBright(g(r))),void 0!==n&&f.cell(s.magentaBright(d.compress),s.cyanBright(g(n))),void 0!==a&&f.cell(s.magentaBright(d.timed),s.cyanBright(g(a))),void 0!==t&&f.cell(s.magentaBright(d.analyze),s.cyanBright(g(t))),void 0!==u&&f.cell(s.magentaBright(d.upload),s.cyanBright(g(u))),f.newRow(),console.log(f.toString())}function z(e,t){console.log(s[`${e}Bright`](t))}function P(e){console.log(s.white.bgMagenta(`### ${u[e]} ###`))}function R(e){return e.split("-").reduce((e,t)=>{return e+t.toLowerCase().replace(/( |^)[a-z]/g,e=>e.toUpperCase())},"")}