const e=require("fs"),t=require("os"),n=require("path"),r=require("url"),o=require("util"),i=require("chalk"),s=require("easy-table"),l=require("latest-version"),c=require("terser"),a=require("webpack");module.exports={AbsPath:S,AsyncTo:w,AutoBin:x,BuildCb:$,CheckJsType:j,CheckPolyfill:b,CompressJs:v,DebugLoaders:T,GetUrl:q,GetVersion:_,IsExist:I,ReadAll:k,ReadFolder:C,ReadHtml:F,ShowInfo:z,ShowMsg:A,ShowTitle:E,TitleCase:P};const{ACTION_TEXT:u,ENV_TEXT:d,INFO_TEXT:g,FormatBool:m}=require("../i18n"),{HOST:f,IS_MPA:h,IS_TS:p,NAME:y,PORT:B}=require("./getting");function S(e,t){const r=t?__dirname:process.cwd();return n.join(r,e)}function w(e){return e.then(e=>[null,e]).catch(e=>[e])}function x(e,...t){require(`../lib/${e}`)(...t)}async function $(e){const t=o.promisify(a),n=await t(e);return w(new Promise((e,t)=>{process.stdout.write(n.toString({children:!1,chunkModules:!1,chunks:!1,colors:!0,modules:!1})+"\n\n"),n.hasErrors()?t(!1):e(!0)}))}function j(){const e={js:0,jsx:0,ts:0,tsx:0},t=Object.keys(e);k(S("src"),r=>{const o=n.extname(r).replace(/\./g,"");t.includes(o)&&(e[o]=e[o]+1)});const{js:r,jsx:o,ts:i,tsx:s}=e;return!r&&!o||i||s||p?r||o||!i&&!s||!p?"none":"ts":"js"}function b(){let t=0;if(h)t=C("src/pages").reduce((t,n)=>{const r=S(`src/pages/${n}/index.${p?"tsx":"jsx"}`);return e.readFileSync(r,"utf8").includes('import "@babel/polyfill"')?t+1:t},0);else{const n=S(`src/index.${p?"tsx":"jsx"}`);e.readFileSync(n,"utf8").includes('import "@babel/polyfill"')&&(t+=1)}return t>0}function v(t){k(t,t=>{if(".js"===n.extname(t)){const n={mangle:{toplevel:!0},nameCache:{}},r=e.readFileSync(t,"utf8"),o=c.minify(r.replace(/"use strict";/,""),n);e.writeFileSync(t,o.code,"utf8")}})}function T(e){console.log(i.redBright("----- Debug Loaders -----"));const t=new s,n={css:null,js:null,img:null,font:null,media:null};Object.keys(n).forEach((r,o)=>{n[r]=e[o].use.map(e=>{if(e.loader.includes("node_modules")){const t=e.loader.split("\\"),n=t.findIndex(e=>"node_modules"===e);return t[n+1]}return e.loader}),t.cell("File",i.magentaBright(r)),t.cell("Loader",i.cyanBright(n[r].reverse().join(" "))),t.newRow()}),console.log(t.toString());const r=new s,{plugins:o,presets:l}=e[1].use[0].options,c={plugins:o,presets:l};for(let e in c)c[e]=c[e].map(e=>{let t=e.constructor===Array?e[0]:e;if(t.includes("node_modules")){const e=t.split("\\"),n=e.findIndex(e=>"node_modules"===e);t=e[n+1]}return t}),r.cell("Option",i.magentaBright(e)),r.cell("Package",i.cyanBright(c[e].join(" "))),r.newRow();console.log(r.toString())}function q(e=B,n,o){const i=o?(()=>{const e=t.networkInterfaces();for(let t in e)for(var n=0;n<e[t].length;n++){var r=e[t][n];if("IPv4"===r.family&&"127.0.0.1"!==r.address&&!r.internal)return r.address}})():"",s=r.format({hostname:i||f,pathname:n,port:e,protocol:"http"});return decodeURIComponent(s)}async function _(e){return e.reduce(async(e,t)=>{const n=await e,r=await l(t);return n[t]=r,n},Promise.resolve({}))}function I(t,n){return e.existsSync(S(t,n))}function k(t,r){const o=e.readdirSync(t);for(let i of o){const o=n.normalize(`${t}/${i}`),s=e.statSync(o);s.isFile()&&r&&r(o),s.isDirectory()&&"node_modules"!==i&&k(o,r)}}function C(t,r){const o=S(t,r);return I(t,r)?e.readdirSync(o).filter(t=>e.statSync(n.normalize(`${o}/${t}`)).isDirectory()):[]}function F(t,r){let o=[];if(I(t,r))if(I(`${t}/pages`,r)){const i=S(`${t}/pages`,r);o=e.readdirSync(i).filter(t=>e.statSync(n.normalize(`${i}/${t}`)).isDirectory())}else{const i=S(t,r);o=e.readdirSync(i).filter(t=>e.statSync(n.normalize(`${i}/${t}`)).isFile()&&".html"===n.extname(n.normalize(`${i}/${t}`))).map(e=>e.split(".")[0])}return o}function z(e){const{analyze:t,compress:n,hash:r,mode:o,output:l,polyfill:c,timed:a,upload:u}=e,f=d[o],h=new s;h.cell(i.magentaBright(g.project),i.cyanBright(y||"demo")),h.cell(i.magentaBright(g.mode),i.cyanBright(f)),void 0!==l&&h.cell(i.magentaBright(g.output),i.cyanBright(m(l))),void 0!==c&&h.cell(i.magentaBright(g.polyfill),i.cyanBright(m(c))),void 0!==r&&h.cell(i.magentaBright(g.hash),i.cyanBright(m(r))),void 0!==n&&h.cell(i.magentaBright(g.compress),i.cyanBright(m(n))),void 0!==a&&h.cell(i.magentaBright(g.timed),i.cyanBright(m(a))),void 0!==t&&h.cell(i.magentaBright(g.analyze),i.cyanBright(m(t))),void 0!==u&&h.cell(i.magentaBright(g.upload),i.cyanBright(m(u))),h.newRow(),console.log(h.toString())}function A(e,t){console.log(i[`${e}Bright`](t))}function E(e){console.log(i.white.bgMagenta(`### ${u[e]} ###`))}function P(e){return e.split("-").reduce((e,t)=>{return e+t.toLowerCase().replace(/( |^)[a-z]/g,e=>e.toUpperCase())},"")}