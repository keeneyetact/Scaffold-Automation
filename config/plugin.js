const e=require("fs"),s=require("webpack"),i=require("webpackbar"),t=require("webpack-build-notifier"),n=require("webpack-bundle-analyzer").BundleAnalyzerPlugin,l=require("clean-webpack-plugin"),r=require("compression-webpack-plugin"),a=require("fork-ts-checker-webpack-plugin"),h=require("friendly-errors-webpack-plugin"),c=require("html-webpack-plugin"),o=require("html-webpack-tags-plugin"),u=require("lodash-webpack-plugin"),p=require("mini-css-extract-plugin"),d=require("webpack-spritesmith"),m=require("stylelint-webpack-plugin"),g=require("vue-loader").VueLoaderPlugin,f=require("uglifyjs-webpack-plugin"),{frame:w,style:b,stylelintIgnores:y,stylelintRules:k,useTs:v}=require("./bruce"),{ACTION_TEXT:q}=require("../i18n"),{AbsPath:E,IsExist:P,ReadEntry:S}=require("../util/setting");module.exports=class{constructor(l){const{MODE:c="dll",USE_ANALYZE:S=!1,USE_COMPRESS:j=!1,USE_CSSLINT:C=!1,USE_HASH:N=!1,USE_JSLINT:O=!1,USE_POLYFILL:T=!1}=l;this.mode=c,this.useCsslint=C,this.useJslint=O,this.usePolyfill=T,this.useHash=N,this.useCompress=j,this.useAnalyze=S,this.define=new s.DefinePlugin({RUN_ENV:JSON.stringify(this.mode)}),this.bar=new i({name:"Webpack Build"}),this.spritesmith=P("src/assets/icon")&&!!e.readdirSync(E("src/assets/icon")).length&&new d({apiOptions:{cssImageRef:"~sprite.png"},spritesmithOptions:{algorithm:"binary-tree"},src:{cwd:E("src/assets/icon"),glob:"*.png"},target:{css:E("src/assets/css/sprite.css"),image:E("src/assets/img/sprite.png")}}),this.stylelint=this.useCsslint&&new m({cache:!0,cacheLocation:E("node_modules/.cache/stylelint-webpack-plugin/.stylelintcache"),configFile:E(`../temp/configs/stylelintrc-${w}.json`,1),configOverrides:{ignoreFiles:y.map(e=>E(e)),rules:k},context:"src",files:"**/*.{css,sass,scss,less,vue}",fix:!1,syntax:b}),this.vueLoader="vue"===w&&new g,"dll"===this.mode?(this.defineDllEnv=new s.DefinePlugin({"process.env.NODE_ENV":JSON.stringify("dev")}),this.dll=new s.DllPlugin({name:"[name]",path:E("dist/static/[name]-manifest.json")}),this.uglifyjs=new f({cache:!0,parallel:!0})):"dev"===this.mode?(this.dllReference=P("dist/static")&&new s.DllReferencePlugin({manifest:require(E("dist/static/vendor-manifest.json"))}),this.hotModuleReplacement=new s.HotModuleReplacementPlugin,this.forkTsChecker=this.useJslint&&v&&new a({reportFiles:["src/**/*.{ts,tsx,vue}"],tsconfig:E("tsconfig.json"),tslint:P("tslint.json")?E("tslint.json"):E(`../temp/configs/tslint-${w}.json`,1)}),this.friendlyErrors=new h,this.htmlTags=P("dist/static")&&new o({append:!1,publicPath:"/",tags:["static/vendor.dll.js"]})):(this.buildNotifier=new t({suppressSuccess:!0,suppressWarning:!0,title:q.build}),this.bundleAnalyzer=this.useAnalyze&&new n({analyzerPort:9090}),this.compression=this.useCompress&&new r({test:/\.(css|js)$/,threshold:10240}),this.htmlTags=this.usePolyfill&&new o({append:!1,publicPath:!1,tags:["https://cdn.polyfill.io/v2/polyfill.min.js"]}),this.lodash=new u,this.miniCssExtract=new p({filename:`css/[name].bundle${this.useHash?".[contenthash:4]":""}.css`}))}clean(...e){return new l({cleanOnceBeforeBuildPatterns:e.map(e=>E(`dist/${e}`))})}html(){const e=S();return e.map(s=>{const i={chunks:["manifest","vendor","index"],chunksSortMode:"manual",favicon:E("src/assets/img/favicon.ico"),filename:`${s}.html`,minify:"dev"!==this.mode&&{collapseWhitespace:!0,removeComments:!0},template:E(`src${e.length>1?`/pages/${s}`:""}/index.html`)};return e.length>1&&Object.assign(i,{chunks:["manifest","vendor","common",s]}),new c(i)})}getPlugin(){let e=[];return(e="dll"===this.mode?[this.define,this.defineDllEnv,this.dll,this.bar,this.uglifyjs,this.clean("static")]:"dev"===this.mode?[this.define,this.dllReference,this.hotModuleReplacement,this.bar,this.forkTsChecker,this.friendlyErrors,this.spritesmith,this.stylelint,this.vueLoader,...this.html(),this.htmlTags]:[this.define,this.bar,this.buildNotifier,this.bundleAnalyzer,this.compression,this.lodash,this.miniCssExtract,this.spritesmith,this.stylelint,this.vueLoader,this.clean(this.mode),...this.html(),this.htmlTags]).filter(Boolean)}};