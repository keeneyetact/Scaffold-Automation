const s=require("eslint-friendly-formatter"),e=require("fibers"),t=require("mini-css-extract-plugin"),o=require("postcss-import"),a=require("postcss-preset-env"),i=require("sass"),{browserList:r,eslintIgnores:l,eslintRules:h,frame:d,includeModules:u,useTs:p}=require("./bruce"),{BROWSER:n}=require("../util/getting"),{AbsPath:c,IsExist:b}=require("../util/setting");module.exports=class{constructor(m){const{HAS_POLYFILL:g=!1,MODE:L="dll",USE_ES6:f=!1,USE_HASH:S=!1,USE_JSLINT:v=!1,USE_POLYFILL:M=!1}=m;this.hasPolyfill=g,this.mode=L,this.useEs6=f,this.useHash=S,this.useJslint=v,this.usePolyfill=M,this.useSourceMap="dev"===this.mode,this.loaderScope=u&&u.length?{include:new RegExp("src|"+u.map(s=>"node_modules/"+s).join("|"))}:{exclude:/node_modules/,include:/src/},this.browser=this.useEs6?n:r,this.envOpts=Object.assign({modules:!1,targets:{browsers:this.browser}},this.hasPolyfill?{corejs:3,useBuiltIns:"entry"}:this.usePolyfill?{}:{corejs:3,useBuiltIns:"usage"}),this.handlebars={helperDirs:c("src/templates/helpers"),partialDirs:c("src/templates/partials")},this.minicss={publicPath:"../"},this.style={sourceMap:this.useSourceMap},this.css={importLoaders:2,sourceMap:this.useSourceMap},this.postcss={postcssOptions:{plugins:[o(),a({browsers:this.browser})]},sourceMap:this.useSourceMap},this.sass={implementation:i,sassOptions:{fiber:e},sourceMap:this.useSourceMap},this.less={sourceMap:this.useSourceMap},this.babel={babelrc:!1,cacheDirectory:!0,comments:!0,cwd:c("..",1),plugins:[["@babel/plugin-transform-runtime",{regenerator:!1,useESModules:!0}],["@babel/plugin-proposal-decorators",{legacy:!0}],["@babel/plugin-proposal-class-properties",{loose:!0}],"@babel/plugin-proposal-nullish-coalescing-operator","@babel/plugin-proposal-optional-chaining","@babel/plugin-syntax-dynamic-import","lodash"],presets:[["@babel/preset-env",this.envOpts],p&&"@babel/preset-typescript"].filter(Boolean),sourceMap:this.useSourceMap},this.babelReact=Object.assign({},this.babel,{plugins:[...this.babel.plugins,b("node_modules/react-hot-loader")&&c("node_modules/react-hot-loader/babel")].filter(Boolean),presets:[...this.babel.presets,"@babel/preset-react"]}),this.babelVue=Object.assign({},this.babel,{presets:[["@babel/preset-env",this.envOpts],p&&["@babel/preset-typescript",{allExtensions:!0}]].filter(Boolean)}),this.eslint={cache:!0,configFile:c(`../temp/configs/eslintrc-${d}.json`,1),cwd:c("..",1),formatter:s,ignorePattern:l,rules:h},this.imagemin={gifsicle:{optimizationLevel:1},mozjpeg:{quality:70},optipng:{enabled:!1},pngquant:{quality:[.7,.9],speed:4}},this.rawLoader={...this.loaderScope,test:/\.txt$/,use:[{loader:"raw-loader"}]},this.hbsLoader={...this.loaderScope,test:/\.(hbs|html)$/,use:[{loader:"handlebars-loader",options:this.handlebars}]},this.cssLoader={include:/(node_modules|src)/,test:/\.css$/,use:[this.useSourceMap?{loader:"style-loader"}:{loader:t.loader,options:this.minicss},{loader:"css-loader",options:this.css},{loader:"postcss-loader",options:this.postcss}]},this.sassLoader={...this.loaderScope,test:/\.(sass|scss)$/,use:[this.useSourceMap?{loader:"style-loader"}:{loader:t.loader,options:this.minicss},{loader:"css-loader",options:this.css},{loader:"postcss-loader",options:this.postcss},{loader:"sass-loader",options:this.sass}]},this.lessLoader={...this.loaderScope,test:/\.less$/,use:[this.useSourceMap?{loader:"style-loader"}:{loader:t.loader,options:this.minicss},{loader:"css-loader",options:this.css},{loader:"postcss-loader",options:this.postcss},{loader:"less-loader",options:this.less}]},this.babelLoader={...this.loaderScope,test:/\.(js|ts)$/,use:[{loader:"babel-loader",options:this.babel}]},this.babelReactLoader={...this.loaderScope,test:/\.(js|ts|jsx|tsx)$/,use:[{loader:"babel-loader",options:this.babelReact}]},this.babelVueLoader={...this.loaderScope,test:/\.(js|ts)$/,use:[{loader:"babel-loader",options:this.babelVue}]},this.vueLoader={...this.loaderScope,test:/\.vue$/,use:[{loader:"vue-loader"}]},this.imgLoader={...this.loaderScope,test:/\.(jpe?g|png|gif|svg)$/,use:[{loader:this.useSourceMap?"file-loader":"url-loader",options:this.useSourceMap?this.file("img"):this.url("img")}]},this.fontLoader={...this.loaderScope,test:/\.(eot|otf|ttf|woff2?)$/,use:[{loader:"file-loader",options:this.file("font")}]},this.mediaLoader={...this.loaderScope,test:/\.(wav|wv|ape|flac|alac|mp3|aac|ogg|opus|mp4|rm|rmvb|3gb|wmv|asf|asx|mov|m4v|avi|dat|mkv|flv|vob)$/,use:[{loader:"file-loader",options:this.file("media")}]}}file(s){return{esModule:!1,name:`[name]${this.useHash?".[hash:4]":""}.[ext]`,outputPath:s}}url(s){return{esModule:!1,limit:10240,name:`[name]${this.useHash?".[hash:4]":""}.[ext]`,outputPath:s}}getLoader(){if(this.useJslint&&!p){const s={loader:"eslint-loader",options:this.eslint};this.babelLoader.use.push(s),this.babelReactLoader.use.push(s),this.babelVueLoader.use.push(s),this.vueLoader.use.push(s)}b("../node_modules/image-webpack-loader",1)&&"dev"!==this.mode&&this.imgLoader.use.push({loader:"image-webpack-loader",options:this.imagemin});const s={default:[this.babelLoader],react:[this.babelReactLoader],vue:[this.babelVueLoader,this.vueLoader]}[d];return{rules:[this.rawLoader,this.hbsLoader,this.cssLoader,this.sassLoader,this.lessLoader,this.imgLoader,this.fontLoader,this.mediaLoader,...s].filter(Boolean)}}};